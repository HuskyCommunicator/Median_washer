# 洗炼助手 Pro (Gear Washer Pro)

专为游戏装备洗炼设计的自动化辅助工具。通过 OCR（光学字符识别）技术读取屏幕上的装备属性，并根据用户自定义的规则自动进行洗炼操作，直到匹配到目标属性为止。

## ✨ 主要功能

*   **智能 OCR 识别**：针对游戏内“黑底彩字”进行专项优化，识别准确率高。
*   **复杂规则匹配**：
    *   支持简单的关键词匹配（如 "冰霜抗性"）。
    *   支持逻辑表达式（如 "攻速 && (暴击 || 爆伤)"）。
    *   支持精准匹配（避免 "法术伤害" 匹配到 "冰冻系法术伤害"）。
    *   支持数值范围匹配。
*   **可视化配置**：提供友好的 GUI 界面，可视化的规则编辑器。
*   **安全防误触**：支持全局热键 (HOME) 随时停止脚本。
*   **后台工作**：脚本运行时可以锁定窗口，不影响其他基本操作（稍微占用鼠标）。

## 🛠️ 环境要求

*   **操作系统**: Windows
*   **Python 版本**: 推荐 **Python 3.12** (注意：Python 3.14 目前与 PyInstaller 存在兼容性问题，打包时请务必使用 3.12 或更低版本)。
*   **依赖库**: 见 `requirements.txt`

## 🚀 快速开始

### 1. 安装依赖

在项目根目录下运行：

```bash
pip install -r requirements.txt
```

### 2. 运行程序

启动图形化界面：

```bash
python gui.py
```

### 3. 使用流程

1.  **新建配置**：点击“新建”按钮，输入装备名称（如“项链”）。
2.  **定位坐标**：跟随向导，依次按下空格键记录：
    *   鼠标悬停在装备图标上（显示浮窗）。
    *   框选浮窗属性文字区域的左上角和右下角（**注意：仅框选文字区域，不要太大**）。
3.  **选择/编辑规则**：
    *   在下拉框选择预设规则。
    *   或点击"编辑规则详情"创建自定义组合逻辑。
4.  **开始洗炼**：
    *   点击"开始洗炼"按钮，程序会自动将鼠标移动到装备位置。
    *   程序会自动读取词缀，判断是否符合规则。
    *   **不符合时会自动按Z键进行洗炼**（鼠标保持在装备位置）。
    *   符合条件时自动停止并弹窗提示。
4.  **开始洗炼**：点击“开始洗炼”，程序将自动接管鼠标。
5.  **停止**：按下 **HOME** 键可强制停止脚本。

## 📦 打包指南 (Build)

如果需要将程序打包成 `.exe` 文件分享给没有 Python 环境的用户，请使用 `PyInstaller`。

**前置条件**: 确保当前 Python 环境为 **3.12** 或更低版本。

### 使用 Spec 文件打包 (推荐)

项目已包含配置好的 `洗炼助手Pro.spec` 文件，直接运行：

```bash
pyinstaller "洗炼助手Pro.spec"
```

### 手动打包步骤 (如果不使用 spec)

```bash
pyinstaller --noconfirm --onedir --windowed --name "洗炼助手Pro" --add-data "config;config" --add-data "src;src" --hidden-import "PIL._tkinter_finder"  gui.py
```

### ⚠️ 打包后的注意事项

打包完成后，生成的文件在 `dist/洗炼助手Pro/` 目录下。

**重要**：由于 Tesseract OCR 引擎较大且文件结构复杂，可能未完全包含在 exe 中，**你需要手动复制 `OCR` 文件夹到打包后的目录中**。

1.  进入 `dist/洗炼助手Pro/` 文件夹。
2.  将项目根目录下的 **`OCR`** 文件夹完整复制进去。
3.  现在的目录结构应该是：
    ```
    dist/洗炼助手Pro/
    ├── OCR/ (手动复制进来的)
    ├── _internal/
    ├── 洗炼助手Pro.exe
    └── ...
    ```
4.  双击 `洗炼助手Pro.exe` 即可运行。

## 📂 项目结构

*   `gui.py`: 图形界面入口。
*   `src/gear_washer/`: 核心逻辑代码 (OCR, 匹配器, 洗炼循环)。
*   `config/`: 配置文件。
*   `OCR/`: Tesseract OCR 引擎及语言包。
*   `ocr_debug/`: 调试模式下生成的 OCR 截图。

## ❓ 常见问题

**Q: OCR 识别全是乱码？**
A: 请确保在 GUI 中勾选“调试模式”，然后检查 `ocr_debug` 文件夹下的图片。
   - 如果图片包含大量非文字区域，请重新“定位”，减小框选范围。
   - 程序默认针对“黑底”优化，如果背景不同可能需要调整 `src/gear_washer/screen.py` 中的预处理逻辑。

**Q: 打包运行时报错 "Failed to execute script..."?**
A: 
1. 确认是否使用了 Python 3.14 (请降级到 3.12)。
2. 确认是否忘记复制 `OCR` 文件夹到 exe 同级目录。
